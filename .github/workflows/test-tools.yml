name: Test All Tools Installation

# This workflow tests the installation of all Jok3r tools
# It runs the complete toolbox installation process and verifies each tool
# Purpose: Ensure all tools can be installed successfully and pass their checks
# Trigger: On push to main/master/develop, PRs, weekly schedule, or manual dispatch

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Mondays at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-toolbox:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Only read access needed for checkout
    container:
      image: archlinux:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize BlackArch repository
      run: |
        curl -O https://blackarch.org/strap.sh
        chmod +x strap.sh
        ./strap.sh
        rm -f strap.sh
        pacman -Syu --noconfirm

    - name: Install system dependencies
      run: |
        pacman -S --noconfirm python python-pip rbenv ruby-build git which

    - name: Initialize rbenv for Ruby tools
      run: |
        echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(rbenv init -)"' >> ~/.bashrc

    - name: Install Python dependencies
      run: |
        pip install --break-system-packages -r requirements.txt

    - name: Install additional tools dependencies
      run: |
        # Install common tools that might be needed
        pacman -S --noconfirm base-devel wget curl jq

    - name: Install all tools (--install-all)
      id: install_tools
      run: |
        echo "::group::Installing all tools"
        python3 jok3r.py toolbox --install-all --auto
        INSTALL_EXIT_CODE=$?
        echo "::endgroup::"
        echo "install_exit_code=$INSTALL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $INSTALL_EXIT_CODE
      continue-on-error: true

    - name: Check installed tools (--check)
      id: check_tools
      run: |
        echo "::group::Checking all installed tools"
        python3 jok3r.py toolbox --check
        CHECK_EXIT_CODE=$?
        echo "::endgroup::"
        echo "check_exit_code=$CHECK_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $CHECK_EXIT_CODE
      continue-on-error: true

    - name: Display toolbox content (--show-all)
      run: |
        echo "::group::Toolbox Content"
        python3 jok3r.py toolbox --show-all || echo "Show-all completed with warnings"
        echo "::endgroup::"
      continue-on-error: true

    - name: Generate installation summary
      if: always()
      run: |
        echo "## Toolbox Installation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.install_tools.outputs.install_exit_code }}" = "0" ]; then
          echo "✅ **Tool Installation**: SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Tool Installation**: FAILED (Exit Code: ${{ steps.install_tools.outputs.install_exit_code }})" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.check_tools.outputs.check_exit_code }}" = "0" ]; then
          echo "✅ **Tool Check**: SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **Tool Check**: FAILED (Exit Code: ${{ steps.check_tools.outputs.check_exit_code }})" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Details" >> $GITHUB_STEP_SUMMARY
        echo "- Installation command: \`python3 jok3r.py toolbox --install-all --auto\`" >> $GITHUB_STEP_SUMMARY
        echo "- Check command: \`python3 jok3r.py toolbox --check\`" >> $GITHUB_STEP_SUMMARY
        echo "- View details in the job logs above" >> $GITHUB_STEP_SUMMARY

    - name: Final status check
      if: always()
      run: |
        INSTALL_CODE="${{ steps.install_tools.outputs.install_exit_code }}"
        CHECK_CODE="${{ steps.check_tools.outputs.check_exit_code }}"

        echo "Installation exit code: $INSTALL_CODE"
        echo "Check exit code: $CHECK_CODE"

        # Fail the workflow if installation or check failed
        if [ "$INSTALL_CODE" != "0" ] || [ "$CHECK_CODE" != "0" ]; then
          echo "❌ Workflow failed: One or more tools failed to install or pass checks"
          exit 1
        fi

        echo "✅ All tools installed and checked successfully!"
